name: QA Validation

on:
  push:
    branches: [ 'main', 'master', 'story-1-2-end-to-end-reservation' ]
  pull_request:
    branches: [ 'main', 'master' ]

jobs:
  qa-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install loguru
        
    - name: Run Syntax Validation
      run: |
        echo "ðŸ” Running QA Syntax Validation..."
        python quick_syntax_check.py
        
    - name: Check Playwright Imports
      run: |
        echo "ðŸ” Checking Playwright Import Safety..."
        python pre-commit-check.py
        
    - name: Validate Critical Files
      run: |
        echo "ðŸ” Validating critical files..."
        
        # Check auth_manager.py specifically
        if [ -f "auth_manager.py" ]; then
          echo "âœ… auth_manager.py found"
          
          # Check for our critical import fix
          if grep -q "from playwright.async_api import Page, Browser, BrowserContext" auth_manager.py; then
            echo "âœ… Playwright imports found in auth_manager.py"
          else
            echo "âŒ Playwright imports missing in auth_manager.py"
            exit 1
          fi
          
          # Check for proper error handling
          if grep -q "except ImportError" auth_manager.py; then
            echo "âœ… Playwright error handling found in auth_manager.py"
          else
            echo "âŒ Playwright error handling missing in auth_manager.py"
            exit 1
          fi
        else
          echo "âŒ auth_manager.py not found"
          exit 1
        fi
        
        # Check bot_orchestrator.py
        if [ -f "bot_orchestrator.py" ]; then
          echo "âœ… bot_orchestrator.py found"
        else
          echo "âŒ bot_orchestrator.py not found"
          exit 1
        fi
        
        # Check browser_automation.py
        if [ -f "browser_automation.py" ]; then
          echo "âœ… browser_automation.py found"
          
          # Check for syntax errors specifically
          python -m py_compile browser_automation.py
          echo "âœ… browser_automation.py syntax valid"
        else
          echo "âŒ browser_automation.py not found"
          exit 1
        fi
        
    - name: Validate Configuration
      run: |
        echo "ðŸ” Validating configuration files..."
        
        # Check config.json
        if [ -f "config.json" ]; then
          echo "âœ… config.json found"
          python -c "import json; json.load(open('config.json'))" && echo "âœ… config.json valid JSON"
        else
          echo "âŒ config.json not found"
          exit 1
        fi
        
        # Check requirements.txt
        if [ -f "requirements.txt" ]; then
          echo "âœ… requirements.txt found"
        else
          echo "âŒ requirements.txt not found"
          exit 1
        fi
        
    - name: Generate QA Report
      run: |
        echo "ðŸ“Š Generating QA Validation Report..."
        cat > qa_validation_report.json << EOF
        {
          "validation_type": "GitHub Actions QA Validation",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "status": "PASSED",
          "checks_performed": [
            "syntax_validation",
            "playwright_import_safety",
            "critical_file_validation",
            "configuration_validation"
          ],
          "ready_for_deployment": true
        }
        EOF
        
    - name: Upload QA Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: qa-validation-report
        path: qa_validation_report.json
        
    - name: Summary
      run: |
        echo "ðŸŽ‰ QA VALIDATION COMPLETED SUCCESSFULLY!"
        echo "âœ… All syntax checks passed"
        echo "âœ… Playwright imports validated"
        echo "âœ… Critical files verified"
        echo "âœ… Configuration validated"
        echo "ðŸš€ Ready for bot execution!"
