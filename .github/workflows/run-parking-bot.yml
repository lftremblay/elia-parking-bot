# DISABLED - This workflow conflicts with scheduled-parking-bot.yml
# Use scheduled-parking-bot.yml instead - it has proper email fallback
name: [DISABLED] Scheduled Parking Bot

on:
  # DISABLED - No triggers to prevent conflicts
  # schedule:
  #   - cron: '0 0 * * 1-5'  # Midnight weekdays (executive spots)
  #   - cron: '0 6 * * 1-5'  # 6 AM weekdays (regular spots)
  # push:
  #   branches: [ 'main', 'master' ]  # Run on pushes to main/master for testing
  # pull_request:
  #   branches: [ 'main', 'master' ]  # Run on pull requests for testing
  workflow_dispatch:  # Allow manual triggering if needed

jobs:
  reserve-parking:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright browsers
      run: |
        # Fix for Ubuntu 24.04 - install correct libasound2 package
        sudo apt-get update
        sudo apt-get install -y libasound2t64
        # Install Playwright browsers with force flag
        playwright install chromium --force

    - name: Create config directory
      run: |
        mkdir -p config logs screenshots session_data

    - name: Create config.json
      run: |
        printf '{
          "elia": {
            "organization": "quebecor",
            "url": "https://app.elia.io/",
            "credentials": {
              "email": "%s",
              "use_sso": true,
              "mfa_method": "authenticator"
            }
          },
          "schedules": {
            "executive_spots": {
              "enabled": true,
              "time": "00:00:00",
              "days_advance": 14,
              "spot_type": "executive",
              "weekdays_only": true
            },
            "regular_spots": {
              "enabled": true,
              "time": "06:00:00",
              "days_advance": 14,
              "spot_type": "regular",
              "weekdays_only": true
            }
          },
          "retry": {
            "max_attempts": 5,
            "backoff_seconds": [5, 10, 30, 60, 120],
            "aggressive_refresh": true
          },
          "notifications": {
            "discord_webhook": "%s",
            "telegram_bot_token": "%s",
            "telegram_chat_id": "%s",
            "email": {
              "enabled": false
            }
          },
          "advanced": {
            "headless": true,
            "browser_profile_path": "./browser_data",
            "session_persistence": true,
            "screenshot_on_error": true,
            "ai_spot_detection": true,
            "use_api_when_possible": true
          }
        }\n' "$ELIA_EMAIL" "$DISCORD_WEBHOOK_URL" "$TELEGRAM_BOT_TOKEN" "$TELEGRAM_CHAT_ID" > config.json
        
        echo "Created config.json"

    - name: Run Parking Reservation
      env:
        ELIA_EMAIL: ${{ secrets.ELIA_EMAIL }}
        ELIA_PASSWORD: ${{ secrets.ELIA_PASSWORD }}
        TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Determine spot type based on schedule or manual trigger
        if [ "$GITHUB_EVENT_NAME" = "schedule" ] && [ "$GITHUB_EVENT_SCHEDULE" = "0 0 * * 1-5" ]; then
          spot_type="executive"
          echo "Scheduled executive spot reservation"
        elif [ "$GITHUB_EVENT_NAME" = "schedule" ] && [ "$GITHUB_EVENT_SCHEDULE" = "0 6 * * 1-5" ]; then
          spot_type="regular"
          echo "Scheduled regular spot reservation"
        else
          spot_type="regular"
          echo "Defaulting to regular spot"
        fi

        # Run the bot
        python main.py --reserve $spot_type

    - name: Upload logs and screenshots on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: parking-bot-logs-${{ github.run_number }}
        path: |
          logs/
          screenshots/
          session_data/
