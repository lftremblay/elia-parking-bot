name: Scheduled Parking Bot

on:
  schedule:
    - cron: '0 0 * * 1-5'  # Midnight weekdays (executive spots)
    - cron: '0 6 * * 1-5'  # 6 AM weekdays (regular spots)
  push:
    branches: [ 'main', 'master' ]  # Run on pushes to main/master for testing
  pull_request:
    branches: [ 'main', 'master' ]  # Run on pull requests for testing

jobs:
  reserve-parking:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # Reduced from 30 minutes for faster failure detection

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright browsers
      run: playwright install chromium

    - name: Create config directory
      run: |
        mkdir -p config logs screenshots session_data

    - name: Create config.json
      env:
        ELIA_EMAIL: ${{ secrets.ELIA_EMAIL }}
        ELIA_PASSWORD: ${{ secrets.ELIA_PASSWORD }}
        TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ðŸ”§ CRITICAL: Removing any existing config.json to ensure fresh creation"
        rm -f config.json
        
        echo "ðŸ” DEBUG: ELIA_EMAIL value: '$ELIA_EMAIL'"
        echo "ðŸ” DEBUG: ELIA_EMAIL length: ${#ELIA_EMAIL}"
        if [ -z "$ELIA_EMAIL" ]; then
          echo "âŒ CRITICAL: ELIA_EMAIL is empty or not set!"
          echo "ðŸ”§ FALLBACK: Using hardcoded email for testing"
          ELIA_EMAIL="louis-felix.tremblay@videotron.com"
        fi
        echo "âœ… Using email: $ELIA_EMAIL"
        echo "âœ… Email length: ${#ELIA_EMAIL}"
        echo "ðŸ” DEBUG: TOTP_SECRET value: '$TOTP_SECRET'"
        echo "ðŸ” DEBUG: TOTP_SECRET length: ${#TOTP_SECRET}"
        if [ -z "$TOTP_SECRET" ]; then
          echo "âŒ CRITICAL: TOTP_SECRET is empty or not set!"
          echo "ðŸ”§ FALLBACK: Using test TOTP secret for debugging"
          TOTP_SECRET="JBSWY3DPEHPK3PXP"  # Google's test secret
        fi
        echo "âœ… Using TOTP secret length: ${#TOTP_SECRET}"
        cat > config.json << EOF
        {
          "elia": {
            "organization": "quebecor",
            "url": "https://app.elia.io/",
            "credentials": {
              "email": "$ELIA_EMAIL",
              "use_sso": true,
              "mfa_method": "authenticator"
            }
          },
          "schedules": {
            "executive_spots": {
              "enabled": true,
              "time": "00:00:00",
              "days_advance": 14,
              "spot_type": "executive",
              "weekdays_only": true
            },
            "regular_spots": {
              "enabled": true,
              "time": "06:00:00",
              "days_advance": 14,
              "spot_type": "regular",
              "weekdays_only": true
            }
          },
          "retry": {
            "max_attempts": 5,
            "backoff_seconds": [5, 10, 30, 60, 120],
            "aggressive_refresh": true
          },
          "notifications": {
            "discord_webhook": "$DISCORD_WEBHOOK_URL",
            "telegram_bot_token": "$TELEGRAM_BOT_TOKEN",
            "telegram_chat_id": "$TELEGRAM_CHAT_ID",
            "email": {
              "enabled": false
            }
          },
          "advanced": {
            "headless": true,
            "browser_profile_path": "./browser_data",
            "session_persistence": true,
            "screenshot_on_error": true,
            "ai_spot_detection": true,
            "use_api_when_possible": true
          }
        }
        EOF

        echo "âœ… Created config.json"
        echo "ðŸ” DEBUG: Verifying config.json content..."
        echo "ðŸ” DEBUG: Email in config.json:"
        grep -A 2 '"email"' config.json || echo "âŒ EMAIL NOT FOUND IN CONFIG!"
        echo "ðŸ” DEBUG: Config file size: $(wc -c < config.json) bytes"
        echo "ðŸ” DEBUG: Verifying config.json content:"
        cat config.json | grep -A 5 -B 5 email

    - name: Run Parking Reservation
      env:
        ELIA_EMAIL: ${{ secrets.ELIA_EMAIL }}
        ELIA_PASSWORD: ${{ secrets.ELIA_PASSWORD }}
        TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Determine spot type based on schedule or manual trigger
        if [ "$GITHUB_EVENT_NAME" = "schedule" ] && [ "$GITHUB_EVENT_SCHEDULE" = "0 0 * * 1-5" ]; then
          spot_type="executive"
          echo "Scheduled executive spot reservation"
        elif [ "$GITHUB_EVENT_NAME" = "schedule" ] && [ "$GITHUB_EVENT_SCHEDULE" = "0 6 * * 1-5" ]; then
          spot_type="regular"
          echo "Scheduled regular spot reservation"
        else
          spot_type="regular"
          echo "Defaulting to regular spot"
        fi

        # Run the bot with timeout for faster failure detection
        echo "ðŸš€ Starting parking bot with 6-minute timeout..."
        timeout 360s python main.py --reserve $spot_type --headless || {
          echo "â° Bot timeout reached - capturing logs for debugging"
          echo "ðŸ“¸ Taking immediate screenshot for timeout debugging..."
          mkdir -p screenshots
          ls -la screenshots/ || echo "No screenshots directory found"
          echo "ðŸ” Current working directory contents:"
          ls -la || echo "Cannot list directory"
          exit 1
        }

    - name: Upload logs and screenshots on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: parking-bot-logs-${{ github.run_number }}
        path: |
          logs/
          screenshots/
          session_data/
