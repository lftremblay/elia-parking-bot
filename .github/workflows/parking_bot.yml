name: Elia Parking Bot

on:
  workflow_dispatch:
    inputs:
      spot_type:
        description: 'Spot type to reserve'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - regular
          - executive
  
  schedule:
    # Executive spots: Midnight EST (5 AM UTC)
    - cron: '0 5 * * 1-5'
    # Regular spots: 6 AM EST (11 AM UTC)  
    - cron: '0 11 * * 1-5'
  
  push:
    branches: [ main ]

jobs:
  reserve-parking:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          # Install system dependencies
          sudo apt-get update
          sudo apt-get install -y libglib2.0-0 libsm6 libxrender1 libxext6
          
          # Install Python packages with specific versions
          pip install --upgrade pip
          pip install numpy==1.26.4
          pip install opencv-python-headless==4.8.0.74
          pip install playwright loguru python-dotenv pyotp cryptography
          
          # Set up Playwright
          playwright install chromium
          playwright install-deps chromium
          
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install numpy==1.26.4
          pip install opencv-python-headless==4.8.0.74
          pip install Pillow==10.0.0  # Add this line
          pip install playwright loguru python-dotenv pyotp cryptography
          playwright install chromium
          playwright install-deps chromium
        run: |
          pip install --upgrade pip
          pip install numpy==1.26.4
          pip install opencv-python-headless==4.8.0.74
          pip install Pillow==10.0.0  # Add this line
          pip install playwright loguru python-dotenv pyotp cryptography
          playwright install chromium
          playwright install-deps chromium
      
      - name: Run bot
        env:
          ELIA_ORG: quebecor
          ELIA_EMAIL: louis-felix.tremblay@videotron.com
          ELIA_PASSWORD: ${{ secrets.ELIA_PASSWORD }}
          TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.spot_type }}" == "all" ]; then
              python main.py --reserve-all
            else
              python main.py --reserve ${{ github.event.inputs.spot_type }}
            fi
          else
            echo "Scheduled run - determining spot type based on time"
            python main.py --reserve-all
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-${{ github.run_number }}
          path: |
            screenshots/
            logs/
