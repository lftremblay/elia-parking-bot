name: Parking Bot Midnight & 6AM Runs
on:
  schedule:
    # Run 10 minutes before midnight Eastern Time (to account for GitHub delays)
    # EST: UTC-5 (Nov-Mar), EDT: UTC-4 (Mar-Nov)
    # 11:50 PM EST = 4:50 UTC, 11:50 PM EDT = 3:50 UTC
    - cron: '50 3,4 * * 1-5'  # 11:50 PM EST/EDT (Monday-Friday)
    
    # Run 10 minutes before 6 AM Eastern Time (second attempt)
    # 5:50 AM EST = 10:50 UTC, 5:50 AM EDT = 9:50 UTC
    - cron: '50 9,10 * * 1-5'  # 5:50 AM EST/EDT (Monday-Friday)
  workflow_dispatch:  # Allow manual runs

jobs:
  run-parking-bot:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install python-dotenv httpx loguru asyncio pytz
        
    - name: Wait and run bot at exact midnight or 6 AM
      env:
        ELIA_GRAPHQL_TOKEN: ${{ secrets.ELIA_GRAPHQL_TOKEN }}
        ELIA_EMAIL: ${{ secrets.ELIA_EMAIL }}
        TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
        MICROSOFT_USERNAME: ${{ secrets.MICROSOFT_USERNAME }}
      run: |
        python -c "
        import datetime
        import pytz
        import subprocess
        import sys
        import time
        
        # Get current time in Eastern timezone
        eastern = pytz.timezone('US/Eastern')
        now = datetime.datetime.now(eastern)
        current_hour = now.hour
        current_minute = now.minute
        
        print(f'üïê Current Eastern time: {now.strftime(\"%Y-%m-%d %H:%M:%S %Z\")}')
        
        # Determine target time (midnight or 6 AM)
        if current_hour == 23 or (current_hour == 0 and current_minute < 15):
            target_hour = 0
            target_name = 'midnight'
        elif current_hour == 5 or (current_hour == 6 and current_minute < 15):
            target_hour = 6
            target_name = '6 AM'
        else:
            print(f'‚è≠Ô∏è Not near midnight or 6 AM (current hour: {current_hour}) - skipping')
            sys.exit(0)
        
        # Calculate target time
        target = now.replace(hour=target_hour, minute=0, second=0, microsecond=0)
        if target < now:
            # If target already passed, add 1 day
            target += datetime.timedelta(days=1)
        
        # Calculate sleep duration
        sleep_seconds = (target - now).total_seconds()
        
        # Safety check: if sleep is more than 20 minutes, something is wrong
        if sleep_seconds > 1200:  # 20 minutes
            print(f'‚ùå ERROR: Sleep duration too long ({sleep_seconds/60:.1f} minutes)')
            print(f'   Current time: {now.strftime(\"%H:%M:%S\")}')
            print(f'   Target time: {target.strftime(\"%H:%M:%S\")}')
            print(f'   Running immediately instead of sleeping')
            sleep_seconds = 0
        
        print(f'üéØ Target time: {target_name} ({target.strftime(\"%H:%M:%S\")})')
        print(f'‚è∞ Sleeping for {sleep_seconds:.1f} seconds ({sleep_seconds/60:.1f} minutes)...')
        
        # Sleep until target time (or skip if 0)
        if sleep_seconds > 0:
            time.sleep(sleep_seconds)
        
        # Verify we're at the right time
        now_after_sleep = datetime.datetime.now(eastern)
        print(f'‚úÖ Woke up at: {now_after_sleep.strftime(\"%Y-%m-%d %H:%M:%S %Z\")}')
        print(f'üöÄ Running parking bot...')
        
        # Run the bot
        subprocess.run([sys.executable, 'fresh_run.py'])
        "
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-logs
        path: logs/
