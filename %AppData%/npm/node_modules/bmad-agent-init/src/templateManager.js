const fs = require('fs-extra');
const path = require('path');
const ora = require('ora');

/**
 * Copies template files to the target directory.
 * @param {string} targetDir - The root directory of the user's project.
 * @param {Object} options - Command line options (e.g., minimal setup).
 */
async function copyTemplates(targetDir, options) {
  console.log('[templateManager] Starting copyTemplates...');
  console.log(`[templateManager] targetDir: ${targetDir}`);
  const spinner = ora('Setting up project structure...').start();
  
  // Define the source of the templates within this package
  const templateSourceDir = path.resolve(__dirname, '..', 'templates', 'bmad-agent');
  console.log(`[templateManager] __dirname: ${__dirname}`);
  console.log(`[templateManager] Resolved templateSourceDir: ${templateSourceDir}`);
  
  // Define target directories
  const targetBmadAgentDir = path.join(targetDir, 'bmad-agent');
  const targetDocsDir = path.join(targetDir, 'docs');

  try {
    // Ensure the source template directory exists (important for local dev and packaging)
    if (!fs.existsSync(templateSourceDir)) {
      console.error(`[templateManager] CRITICAL: Template source directory NOT FOUND at ${templateSourceDir}`);
      spinner.fail('Template source directory not found. This is an internal error.');
      throw new Error(`Template source directory missing at ${templateSourceDir}. Please report this issue.`);
    }

    // Create the bmad-agent directory
    console.log(`[templateManager] Creating bmad-agent directory at ${targetBmadAgentDir}`);
    await fs.ensureDir(targetBmadAgentDir);
    
    // Copy the template files to the bmad-agent directory
    console.log(`[templateManager] Copying template files to ${targetBmadAgentDir}`);
    await fs.copy(templateSourceDir, targetBmadAgentDir);
    
    // Create the docs directory at the root level
    console.log(`[templateManager] Creating docs directory at ${targetDocsDir}`);
    await fs.ensureDir(targetDocsDir);
    
    // Add a README.md to the docs directory
    const docsReadmePath = path.join(targetDocsDir, 'README.md');
    await fs.writeFile(
      docsReadmePath,
      '# BMAD Agent Documentation\n\nThis directory contains documentation generated by the BMAD Agent.\n',
      'utf8'
    );
    
    // Copy any default documentation templates if they exist in the template
    const templateDocsDir = path.join(templateSourceDir, 'templates', 'docs');
    if (fs.existsSync(templateDocsDir)) {
      console.log(`[templateManager] Copying default documentation templates to ${targetDocsDir}`);
      await fs.copy(templateDocsDir, targetDocsDir, { overwrite: false });
    }

    // TODO: Implement minimal setup if options.minimal is true
    if (options.minimal) {
      spinner.info('Minimal setup selected. (Note: Minimal copy logic not yet fully implemented).');
      // Example: Remove non-essential directories or files after full copy, or copy selectively.
    }

    spinner.succeed('Project structure created successfully.');
    console.log('[templateManager] copyTemplates finished successfully.');
  } catch (error) {
    spinner.fail('Failed to set up project structure.');
    console.error('Detailed error:', error);
    console.error('[templateManager] Error in copyTemplates:', error);
    throw error;
  }
}

module.exports = {
  copyTemplates,
};